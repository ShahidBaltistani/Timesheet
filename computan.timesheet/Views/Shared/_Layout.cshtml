<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="referrer" content="no-referrer"/>
    <title>@ViewBag.Title - Computan Timesheet</title>
    <!-- Global stylesheets -->
    <link href="~/Content/fonts.googleapis.min.css" rel="stylesheet"/>
    <!-- /theme JS files -->
    @Styles.Render("~/Content/css")
    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/jqueryval")
    @Scripts.Render("~/bundles/bootstrap")
    @Scripts.Render("~/Scripts/corejs")
    @Scripts.Render("~/Scripts/datatables")
    <link href="~/Content/fontawesome/styles.min.css" rel="stylesheet"/>
    <link href="~/Content/Site.min.css" rel="stylesheet">
    @RenderSection("scripts", false)
    <script src="~/Scripts/jquery-ui.min.js"></script>
    <script type="text/javascript" src="~/Scripts/custom/mynotification.min.js"></script>
    <script src="~/Scripts/default/plugins/autosize/autosize.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        (function(d, t) {
            var bh = d.createElement(t), s = d.getElementsByTagName(t)[0];
            bh.type = 'text/javascript';
            bh.src = 'https://www.bugherd.com/sidebarv2.js?apikey=xpd7ogrpmzfnd8fxl8cveq';
            s.parentNode.insertBefore(bh, s);
        })(document, 'script');
    </script>
</head>
<body class="sidebar-xs">
    <!-- Main navbar -->
    <div class="navbar navbar-inverse">
        <div class="navbar-header">
            <a class="navbar-brand" href="/">
                <img src="~/Images/Logo.png" />
            </a>
            <ul class="nav navbar-nav visible-xs-block">
                <li>
                    <a data-toggle="collapse" data-target="#navbar-mobile">
                        <i class="icon-tree5"></i>
                    </a>
                </li>
                <li>
                    <a class="sidebar-mobile-main-toggle">
                        <i class="icon-paragraph-justify3"></i>
                    </a>
                </li>
            </ul>
        </div>
        <div class="navbar-collapse collapse" id="navbar-mobile">
            <ul class="nav navbar-nav">
                <li>
                    <a class="sidebar-control sidebar-main-toggle hidden-xs" data-toggle="tooltip" title="Sidebar">
                        <i class="icon-paragraph-justify3"></i>
                    </a>
                </li>
                <li>
                    <a href="/home/index/" data-toggle="tooltip" title="Home">
                        <i class="icon-home4"></i>
                        <span class="visible-xs-inline-block position-right">Home</span>
                    </a>
                </li>
                <li>
                    <a href="/tickets/index/1" data-toggle="tooltip" title="New Tickets">
                        <i class="icon-envelop5"></i>
                        <span class="visible-xs-inline-block position-right">New Tickets</span>
                    </a>
                </li>
                <li class="dropdown">
                    <a href="#search" class="topbucketbtn" data-toggle="tooltip" title="Global Bucket">
                        <i class="icon-cart5"></i>
                        <span class="visible-xs-inline-block position-right">Global Bucket</span>
                        <span class="badge bg-warning-400 bucktcount" id="bucktscount"></span>
                    </a>
                </li>
                <li class="dropdown">
                    @if (User.IsInRole("Admin"))
                    {
                        <a href="/tickettimelogs/team" data-toggle="tooltip" title="Team Time Log">
                            <i class="fa fa-clock-o" style="font-size: 1.5em !important;"></i>
                            <span class="visible-xs-inline-block position-right">Team Time Log</span>
                        </a>
                    }
                    else
                    {
                        <a href="/tickettimelogs/index" data-toggle="tooltip" title="My Time Log">
                            <i class="fa fa-clock-o" style="font-size: 1.5em !important;"></i>
                            <span class="visible-xs-inline-block position-right">My Time Log</span>
                        </a>
                    }
                </li>
                <li>
                    <a href="/clients/index/" data-toggle="tooltip" title="Clients List">
                        <i class="icon-users4"></i><span class="visible-xs-inline-block position-right">Clients list</span>
                    </a>
                </li>

                <li>
                    <a href="/Settings/OrphanedTicketSetting/" data-toggle="tooltip" title="Settings">
                        <i class="icon-cog3"></i><span class="visible-xs-inline-block position-right">Time entry</span>
                    </a>
                </li>

            </ul>
            @if (Request.IsAuthenticated)
            {
                using (Html.BeginForm("LogOff", "Account", FormMethod.Post, new { id = "logoutForm" }))
                {
                    @Html.AntiForgeryToken()
                    <div class="showFullName"></div>
                }
            }
        </div>
    </div>
    <!-- /main navbar -->
    <div class="page-container">
        <div class="page-content">
            <!-- Main sidebar -->
            <div class="sidebar sidebar-main">
                <div class="sidebar-content">
                    <!-- User menu -->
                    <div class="sidebar-user">
                        <div class="category-content">
                            <div class="media" id="Showfullnamewithcity"> </div>
                        </div>
                    </div>
                    <!-- /user menu -->
                    <!-- Main navigation -->
                    @{ Html.RenderAction("Index", "sidemenu"); }
                    <!-- /main navigation -->
                </div>
            </div>
            <!-- /main sidebar -->
            <!-- Secondary sidebar -->
            @RenderSection("secondarysidebar", false)
            <!-- /secondary sidebar -->
            <!-- Main content -->
            <div class="content-wrapper" style="background-color: ghostwhite;">
                @RenderSection("header", false)
                <div class="content">
                    @RenderBody()
                    <div id="topbucket">
                        <button type="button" class="close model-close-button">×</button>
                        <div class="col-md-11 glockbucketpanel">
                            <div class="panel panel-default panel-bordered">
                                <div class="panel-heading">
                                    <div class="form-inline">
                                        <div class="form-group">
                                            <h5 class="panel-title">My Buckets</h5>
                                        </div>
                                        <div class="form-group BucketSearchFilter"> </div>
                                    </div>
                                </div>
                                <div class="panel-body" style="max-height: 500px; overflow-y: scroll;">
                                    <div class="GlobalBucketslist"> </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Footer -->
                    <div class="footer text-muted footer-color">
                        &copy; @DateTime.Now.Year <a href="/">Timesheet</a> By <a href="https://www.computan.com/" target="_blank">Computan</a>
                    </div>
                    <input type="hidden" class="ajaxnotcall" value="1" />
                    <!-- /footer -->
                </div>
            </div>
        </div>
    </div>

    <div class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Enable OPTP</h5>
                </div>
                <div class="modal-body">
                    <div class=" col-md-10 col-md-offset-1">
                        <a href="/account/EnableAppAuthenticator" class="btn-primary btn-blocks">Enable Two-factor authentication via TOTP </a>
                    </div>
                    <style>
                        .btn-blocks {
                            padding: 15px 10px;
                            text-align: center;
                            border-radius: 10px;
                            font-size: 18px;
                            line-height: 21px;
                        }

                        .btn-blocks {
                            display: block;
                            width: 100%;
                        }
                    </style>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>
    <!--Spinner-->
    <script src="https://www.gstatic.com/firebasejs/5.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.10.1/firebase-messaging.js"></script>
    <div id="spinner" class="ajaxloader" style="display: none;">
        <img id="img-spinner" src="~/Content/images/loader.gif" alt="Loading" />
    </div>
    <script type="text/javascript">
        var model = $('.showFullName');
        $(document).ready(function () {
            $.ajax({
                url: "/Account/CheckOPTPEnabled",
                //data: { id: credentialid },
                type: 'GET'
            }).done(function (data) {
                if (data == true) {
                    $(".modal").modal({ backdrop: 'static', keyboard: false })
                    $(".modal").modal('show');
                }
                else {
                }
            });
            $.ajax({
                url: "/home/showfullname/",
                type: "Get",
                success: function (data) { model.empty().append(data); }
            });
            $.ajax({
                url: "/home/Showfullnamewithcity/",
                type: "Get",
                success: function (data) { $("#Showfullnamewithcity").empty().append(data); }
            });
            $.ajax({
                url: "/GlobalBuckets/getbucktscount/",
                type: "Get",
                success: function (data) { $("#bucktscount").html(data) }
            });
        });
        //$(document).ajaxError(function(xhr, props) {
        //    var returnUrl = window.location.pathname;
        //    if (props.status === 403) {
        //        swal({ title: "Login Required!", text: "Please login to continue", timer: 2000, showConfirmButton: false });
        //        setInterval(function() {
        //                $.ajax({
        //                    url: "/ajaxlogin/RedirectToLogin/",
        //                    type: "Get",
        //                    data: { returnUrl: returnUrl },
        //                    success: function(data) { window.location.href = data.redirectTo; }
        //                });
        //            },
        //            2000);
        //    }
        //});
        const firebaseConfig = {
            apiKey: "AIzaSyD3CgcDFetd-MyAzPSVjD-Ui8UEPLCJ0l4",
            authDomain: "timesheet-44f54.firebaseapp.com",
            databaseURL: "https://timesheet-44f54-default-rtdb.firebaseio.com",
            projectId: "timesheet-44f54",
            storageBucket: "timesheet-44f54.appspot.com",
            messagingSenderId: "46428946455",
            appId: "1:46428946455:web:ff58917a24430355bedc52"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const messaging = firebase.messaging();
        messaging.requestPermission()
            .then(function () {
                return messaging.getToken();
            })
            .catch(function (err) {
                console.log("Unable to get permission to notify.", err);
            });
        messaging.onMessage(function (payload) {
            var message = JSON.stringify(payload.notification);
            var data = JSON.stringify(payload.data);
            data = JSON.parse(data);
            var notification = JSON.parse(message);
            if (data.action == 7) {
                var messagebody = "<a href=" + "/tickets/comment/" + data.ticketid + "/" + data.comment + " target='_blank'>" + notification.body + "</a>";
            } else {
                var messagebody = "<a href=" + "/tickets/ticketitem/" + data.ticketid + " target='_blank'>" + notification.body + "</a>";
            }
            $.jGrowl(messagebody, { header: notification.title, position: 'bottom-right', theme: 'alert-bordered alert-primary' });
        });
    </script>
    <script src="~/Scripts/custom/Global.min.js"></script>
</body>
</html>