@model IEnumerable<computan.timesheet.core.Rule>
@{ ViewBag.Title = "Manage Rules"; }
<div class="panel panel-default" id="maincontent">
    @Html.Partial("_TicketNavTab", "rules")
    <div class="panel-heading">
        <h5 class="panel-title">List All Rules</h5>
        <button value="down" class="icon-arrow-down12 swap"></button>
        <button value="up" class="icon-arrow-up12 swap"></button>
        <div class="heading-elements">
            <div class="btn-group">
                <a href="/rules/create" class="btn btn-primary"><i class="icon-list3 position-left"></i>Add New Rule</a>
            </div>
        </div>
        <a class="heading-elements-toggle">
            <i class="icon-menu"></i>
        </a>
    </div>
    <div id="" class="">
        <div class="">
            <table class="table table-hover" id="roletable" role="grid">
                <tr>
                    <th> @Html.DisplayNameFor(model => model.name) </th>
                    <th> @Html.DisplayNameFor(model => model.runorder) </th>
                    <th> @Html.DisplayNameFor(model => model.isactive) </th>
                    <th></th>
                </tr>
                <tbody>
                @if (Model != null && Model.Count() > 0)
                {
                    foreach (var item in Model)
                    {
                        <tr data-id="@item.id" data-runorder="@item.runorder">
                            <td> @Html.DisplayFor(modelItem => item.name) </td>
                            <td> @Html.DisplayFor(modelItem => item.runorder) </td>
                            <td> @Html.CheckBoxFor(modelItem => item.isactive, new {@class = "status", data_id = item.id}) </td>
                            <td>
                                @Html.ActionLink("Edit", "Edit", new {item.id}, new {@class = "btn btn-info btn-xs"})
                                @Html.ActionLink("Preview", "Preview", new {item.id}, new {@class = "btn btn-info btn-xs"})
                                @Html.ActionLink("Execute Rule", "ExecuteRule", new {item.id}, new {@class = "btn btn-info btn-xs"})
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr class="text-center">
                        <td colspan="4">Sorry,no rules found.</td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function() {
        //****************************************
        //  Get Selectd tr for sorting run order
        //****************************************
        //Global varibale for selected tr
        var selectedtr = null;
        $(document).on('click',
            '#roletable tbody tr',
            function() {
                selectedtr = $(this);
                //Get tr that have class already class selectdtr
                var alreadyselecttr = $("#roletable tbody tr.selectedtr");
                // check if this tr already has class selected tr
                if ($(this).hasClass("selectedtr")) {
                    $(this).css('background-color', 'white');
                    $(this).removeClass("selectedtr");
                    selectedtr = null;
                } else {
                    var r = $(this).data("id");
                    $(this).css('background-color', 'whitesmoke');
                    $(this).addClass("selectedtr");
                    selectedtr = $(this);
                }
                // if already selected tr is exist then remove the class selected tr
                if (alreadyselecttr.length != 0) {
                    alreadyselecttr.css('background-color', 'white');
                    alreadyselecttr.removeClass("selectedtr");
                }
            });
        //*******************************************
        //      Sorting of rule for run order
        //*******************************************
        $(document).on('click',
            '.swap',
            function() {
                // selected tr is null then show error
                if (selectedtr == null) {
                    swal("Sorry", "Please select row", "error");
                    return false;
                }
                // get value for up/down
                var value = $(this).val(); //up/down
                var id = selectedtr.data('id');
                var currentorder = selectedtr.data("runorder");
                $.ajax({
                    url: "/rules/sortingrow/" + id + "/" + value,
                    data: '',
                    type: 'GET'
                }).done(function(data) {
                    if (data.error) {
                        swal("error", data.errortext, "error");
                        return false;
                    }
                    var prevtr;
                    // if vlue is up then get previous row
                    if (value == 'up') {
                        prevtr = selectedtr.prev(); // getting previous row
                    } else {
                        // if vlue is down then get next row
                        prevtr = selectedtr.next(); //getting next row incase
                    }
                    // get runorder of prevoius/next row
                    var prevorder = prevtr.data("runorder");
                    // get run order of selected row
                    selectedtr.find("td:nth-child(2)").text(prevorder);
                    //update data attribute of selected row  with prevoius/next row run order
                    selectedtr.data('runorder', prevorder);
                    // get run order of  prevoius/next row
                    prevtr.find("td:nth-child(2)").text(currentorder);
                    //update data attribute of prevoius/next row  with selected row run order
                    prevtr.data('runorder', currentorder);
                    // swap the rows accroding to value up/down
                    if (value == 'up') {
                        selectedtr.after(prevtr);
                    } else {
                        prevtr.after(selectedtr);
                    }
                    return false;
                });
            });
        $(document).on('click',
            '.status',
            function() {
                var id = $(this).data("id");
                var statusid;
                if ($(this).is(":checked")) {
                    statusid = true;
                } else {
                    statusid = false;
                }
                $.ajax({
                    url: "/rules/status/",
                    data: {
                        id: id,
                        statusid: statusid
                    },
                    type: 'POST'
                }).done(function(data) {
                    if (data.error) {
                        swal("error", data.errortext, "error");
                        return false;
                    }
                    swal("Status has been updated", data.successtext, "success");
                    return false;
                });
            });
    });
</script>